<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagar Competición</title>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe.js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2>Pago de Inscripción - <span id="competicioNombre"></span></h2>

    <!-- Detalles de la competición -->
    <div>
        <p><strong>Competición:</strong> <span id="competicioNombre"></span></p>
        <p><strong>Fecha de inicio:</strong> <span id="competicioFechaInici"></span></p>
        <p><strong>Fecha de fin:</strong> <span id="competicioFechaFi"></span></p>
        <p><strong>Precio:</strong> <span id="competicioPrecio"></span></p>
    </div>

    <!-- Formulario de pago -->
    <form id="payment-form">
        <div id="card-element">
            <!-- A Stripe Element will be inserted here. -->
        </div>

        <!-- Used to display form errors. -->
        <div id="card-errors" role="alert"></div>

        <button id="submit" class="btn btn-success mt-3">
            Pagar ahora
        </button>
    </form>
</div>

<script>
    var stripe = Stripe('{{stripePublicKey}}'); // Clave pública de Stripe
    var elements = stripe.elements();

    // Crear un elemento de tarjeta
    var card = elements.create('card');
    card.mount('#card-element');

    // Manejar el envío del formulario de pago
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function (event) {
        event.preventDefault();

        // Crea un token de pago con la información de la tarjeta
        stripe.createToken(card).then(function (result) {
            if (result.error) {
                // Muestra el error al usuario
                var errorElement = document.getElementById('card-errors');
                errorElement.textContent = result.error.message;
            } else {
                // Enviar el token a tu servidor para procesar el pago
                stripeTokenHandler(result.token);
            }
        });
    });

    // Envía el token de pago al backend
    function stripeTokenHandler(token) {
        var form = document.getElementById('payment-form');

        // Crea un formulario oculto con el token para enviarlo a tu servidor
        var hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'stripeToken');
        hiddenInput.setAttribute('value', token.id);
        form.appendChild(hiddenInput);

        // Enviar el formulario
        form.submit();
    }

    // Mostrar los detalles de la competición
    document.getElementById("competicioNombre").textContent = "{{competicio.nom}}";
    document.getElementById("competicioFechaInici").textContent = "{{competicio.dataInici}}";
    document.getElementById("competicioFechaFi").textContent = "{{competicio.dataFi}}";
    document.getElementById("competicioPrecio").textContent = "{{competicio.preu}}";
</script>

</body>
</html>
